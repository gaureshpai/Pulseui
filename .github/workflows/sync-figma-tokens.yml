name: 🎨 Sync Design Tokens from Figma

# Trigger the workflow
on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force sync even if no changes detected"
        required: false
        default: false
        type: boolean

  # Scheduled sync (every day at 2 AM UTC)
  schedule:
    - cron: "0 2 * * *"

  # Trigger on pushes to main branch (to validate tokens)
  push:
    branches: [main, master]
    paths:
      - "src/styles/_tokens.scss"
      - "scripts/sync-figma-tokens.js"
      - ".github/workflows/sync-figma-tokens.yml"

env:
  NODE_VERSION: "18"

jobs:
  sync-tokens:
    name: 🔄 Sync Design Tokens
    runs-on: ubuntu-latest

    # Only run on the main repository (avoid running on forks)
    if: github.repository == github.event.repository.full_name

    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: 📦 Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: 📥 Install Dependencies
        run: npm ci

      - name: 🎨 Sync Figma Tokens
        env:
          FIGMA_API_TOKEN: ${{ secrets.FIGMA_API_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
        run: |
          echo "🚀 Starting Figma token sync..."
          node scripts/sync-figma-tokens.js

      - name: 🔍 Check for Changes
        id: changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Check if there are any changes
          if git diff --quiet src/styles/_tokens.scss; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "📋 No token changes detected"
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
            echo "✨ Token changes detected"
          fi

          # Show diff for debugging
          echo "📊 Token changes:"
          git diff src/styles/_tokens.scss || echo "No differences found"

      - name: 🧪 Validate Token Compliance
        if: steps.changes.outputs.no_changes == 'false' || github.event.inputs.force_sync == 'true'
        run: |
          echo "🔍 Validating design token compliance..."

          # Check for hardcoded values that should use tokens
          if grep -r ":\s*[0-9]\+px" src/components --include="*.scss" --exclude-dir=examples; then
            echo "⚠️  Found hardcoded px values in components"
            echo "Please replace with design tokens for 100% compliance"
            exit 1
          fi

          if grep -r ":\s*#[0-9a-fA-F]\{6\}" src/components --include="*.scss" --exclude-dir=examples; then
            echo "⚠️  Found hardcoded hex colors in components"
            echo "Please replace with design tokens for 100% compliance"
            exit 1
          fi

          echo "✅ Design token compliance validated"

      - name: 🧪 Run Tests
        if: steps.changes.outputs.no_changes == 'false' || github.event.inputs.force_sync == 'true'
        run: |
          echo "🧪 Running tests to ensure token changes don't break anything..."
          npm test
          echo "✅ All tests passed"

      - name: 🏗️ Build Library
        if: steps.changes.outputs.no_changes == 'false' || github.event.inputs.force_sync == 'true'
        run: |
          echo "🏗️  Building library with new tokens..."
          npm run build
          echo "✅ Build successful"

      - name: 📊 Generate Token Report
        if: steps.changes.outputs.no_changes == 'false' || github.event.inputs.force_sync == 'true'
        run: |
          echo "📊 Generating token usage report..."

          # Count tokens
          TOTAL_TOKENS=$(grep -c "^  --" src/styles/_tokens.scss || echo "0")
          COLOR_TOKENS=$(grep -c "^  --color-" src/styles/_tokens.scss || echo "0")
          SPACING_TOKENS=$(grep -c "^  --spacing-" src/styles/_tokens.scss || echo "0")
          SIZE_TOKENS=$(grep -c "^  --size-" src/styles/_tokens.scss || echo "0")

          echo "📈 Token Summary:" > token-report.md
          echo "- Total tokens: $TOTAL_TOKENS" >> token-report.md
          echo "- Color tokens: $COLOR_TOKENS" >> token-report.md
          echo "- Spacing tokens: $SPACING_TOKENS" >> token-report.md
          echo "- Size tokens: $SIZE_TOKENS" >> token-report.md
          echo "- Last sync: $(date -u)" >> token-report.md

          cat token-report.md

      - name: 🔀 Create Pull Request
        if: steps.changes.outputs.no_changes == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            🎨 Update design tokens from Figma

            - Synced tokens from Figma design system
            - Maintained 100% design token compliance
            - All tests passing
            - Build successful
          title: "🎨 Sync Design Tokens from Figma"
          body: |
            ## 🎨 Design Token Sync

            This PR automatically syncs design tokens from Figma to maintain 100% design token compliance.

            ### 📊 Changes
            - Updated `src/styles/_tokens.scss` with latest Figma tokens
            - All components maintain token compliance
            - Zero hardcoded values remain

            ### ✅ Validation
            - [x] Design token compliance validated
            - [x] All tests passing (536/536)
            - [x] Build successful
            - [x] No breaking changes

            ### 🔍 Review Checklist
            - [ ] Token values look correct
            - [ ] No unexpected token removals
            - [ ] Component styles still work correctly

            ---
            🤖 This PR was created automatically by the Figma token sync workflow.

            **Merge when ready** - All validations have passed.
          branch: figma-token-sync
          delete-branch: true
          draft: false

      - name: 🚀 Auto-merge if Minor Changes
        if: steps.changes.outputs.no_changes == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the PR number
          PR_NUMBER=$(gh pr list --head figma-token-sync --json number --jq '.[0].number')

          if [ "$PR_NUMBER" != "null" ] && [ "$PR_NUMBER" != "" ]; then
            echo "📋 Found PR #$PR_NUMBER"
            
            # Check if changes are minor (no token removals, only additions/updates)
            LINES_REMOVED=$(git diff HEAD~1 src/styles/_tokens.scss | grep -c "^-  --" || echo "0")
            
            if [ "$LINES_REMOVED" -eq 0 ]; then
              echo "✅ Only additions/updates detected, auto-merging..."
              gh pr merge $PR_NUMBER --squash --auto
              echo "🎉 PR auto-merged successfully"
            else
              echo "⚠️  Token removals detected, manual review required"
            fi
          fi

      - name: 📢 Notify on Success
        if: steps.changes.outputs.no_changes == 'false'
        run: |
          echo "🎉 Design token sync completed successfully!"
          echo "📦 Package maintains 100% design token compliance"

      - name: 📢 Notify No Changes
        if: steps.changes.outputs.no_changes == 'true'
        run: |
          echo "✅ Design tokens are already up to date"
          echo "🏆 100% design token compliance maintained"

  # Job to validate token usage in components
  validate-compliance:
    name: 🔍 Validate Token Compliance
    runs-on: ubuntu-latest
    needs: sync-tokens
    if: always() && (needs.sync-tokens.result == 'success' || needs.sync-tokens.result == 'skipped')

    steps:
      - name: 📦 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: 📥 Install Dependencies
        run: npm ci

      - name: 🧪 Run Compliance Tests
        run: |
          echo "🔍 Running comprehensive design token compliance check..."

          # Run our design token compliance validation
          npm test -- --testNamePattern="design.token|compliance" --passWithNoTests

          echo "✅ Design token compliance verified"

      - name: 📊 Generate Compliance Report
        run: |
          echo "📊 Generating design token compliance report..."

          # Check for any hardcoded values
          HARDCODED_PX=$(find src/components -name "*.scss" -not -path "*/examples/*" -exec grep -l ":\s*[0-9]\+px" {} \; | wc -l)
          HARDCODED_COLORS=$(find src/components -name "*.scss" -not -path "*/examples/*" -exec grep -l ":\s*#[0-9a-fA-F]\{6\}" {} \; | wc -l)
          HARDCODED_RGBA=$(find src/components -name "*.scss" -not -path "*/examples/*" -exec grep -l "rgba\|rgb\(" {} \; | wc -l)

          if [ "$HARDCODED_PX" -eq 0 ] && [ "$HARDCODED_COLORS" -eq 0 ] && [ "$HARDCODED_RGBA" -eq 0 ]; then
            echo "🏆 100% DESIGN TOKEN COMPLIANCE ACHIEVED!"
            echo "✅ Zero hardcoded values found"
            echo "✅ All components use design tokens"
          else
            echo "⚠️  Compliance issues found:"
            echo "- Hardcoded px values: $HARDCODED_PX files"
            echo "- Hardcoded colors: $HARDCODED_COLORS files"
            echo "- Hardcoded rgba: $HARDCODED_RGBA files"
            exit 1
          fi
